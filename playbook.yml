---
- hosts: localhost
  connection: local
  become: true
  vars:
    - gosu_ver: '1.9'
    - logstash_major_ver: '2.2'
    - logstash_ver: '1:2.2.3-1'
  tasks:
    - name: Installing apt-transport-https
      apt:
        name: "apt-transport-https"
        state: "present"

    - name: Installing ca-certificates
      apt:
        name: "ca-certificates"
        state: "latest"

    - name: Installing Logstash Plugins Pre-Reqs
      apt:
        name: "{{ item }}"
        state: "present"
        install_recommends: no
      with_items:
        - 'libzmq3'

    - name: Ensuring /usr/local/lib Exists
      file:
        path: "/usr/local/lib"
        state: "directory"

    # - name: Symlinking libzmq.so
    #   file:
    #     src: "/usr/lib/*/libzmq.so.3"
    #     dest: "/usr/local/lib/libzmq.so"
    #     state: "link"

    - name: Installing dumb-init
      apt:
        deb: "https://github.com/Yelp/dumb-init/releases/download/v1.0.2/dumb-init_1.0.2_amd64.deb"

    - name: Installing gosu
      get_url:
        url: "https://github.com/tianon/gosu/releases/download/{{ gosu_ver }}/gosu-amd64"
        dest: "/usr/local/bin/gosu"
        mode: 0755

    - name: Installing JRE
      apt:
        name: "default-jre-headless"
        state: "present"

    - name: Adding Elasticsearch Repo Key
      apt_key:
        url: "https://packages.elastic.co/GPG-KEY-elasticsearch"
        state: "present"

    - name: Adding Logstash Repo
      apt_repository:
        repo: "deb https://packages.elastic.co/logstash/{{ logstash_major_ver }}/debian stable main"

    - name: Installing Logstash
      apt:
        name: "logstash={{ logstash_ver }}"
        state: "present"
        install_recommends: no

# We are doing this to redirect TCP/514 and UDP/514 to Logstash on TCP/10514
    - name: Configuring Rsyslogd 50-default.conf
      lineinfile:
        line: "*.* @@127.0.0.1:10514"
        dest: "/etc/rsyslog.d/50-default.conf"

# We are doing this to enable Rsyslogd to listen on tcp/514 and udp/514
    - name: Configuring Rsyslogd To Listen On TCP/514 and UDP/514
      lineinfile:
        dest: "/etc/rsyslog.conf"
        line: "{{ item }}"
      with_items:
        - '$ModLoad imudp'
        - '$UDPServerRun 514'
        - '$ModLoad imtcp'
        - '$InputTCPServerRun 514'
